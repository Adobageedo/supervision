<div class="timeline-container">
  <!-- Toolbar -->
  <mat-toolbar color="primary" class="timeline-toolbar">
    <button mat-icon-button (click)="backToInterventions()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span>Bazefield Timeline</span>
    <span class="spacer"></span>
    
    <button mat-icon-button (click)="filterSidebar.open()" aria-label="Filtres">
      <mat-icon>filter_list</mat-icon>
    </button>
    
    <span class="granularity-info">
      {{ displayConfig?.granularity === 'minute' ? 'Vue par 15 minutes' : 
         displayConfig?.granularity === 'hour' ? 'Vue horaire' : 
         displayConfig?.granularity === 'day' ? 'Vue journalière' : 
         'Vue mensuelle' }}
    </span>
  </mat-toolbar>

  <!-- Controls -->
  <div class="controls-bar">
    <div class="time-controls">
      <span class="date-label">{{ getTimeRangeLabel() }}</span>
      
      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button mat-icon-button (click)="zoomOut()" [disabled]="zoomLevel <= 0.25" matTooltip="Zoom arrière">
          <mat-icon>zoom_out</mat-icon>
        </button>
        <span class="zoom-label">{{ (zoomLevel * 100) | number:'1.0-0' }}%</span>
        <button mat-icon-button (click)="zoomIn()" [disabled]="zoomLevel >= 3" matTooltip="Zoom avant">
          <mat-icon>zoom_in</mat-icon>
        </button>
        <button mat-icon-button (click)="resetZoom()" matTooltip="Réinitialiser zoom">
          <mat-icon>restart_alt</mat-icon>
        </button>
      </div>
    </div>
  </div>


  <!-- Legend -->
  <mat-card class="legend-card">
    <mat-card-content>
      <div class="legend-title">
        <mat-icon>info</mat-icon>
        <span>Légende</span>
      </div>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-color" [style.background-color]="getStatusColor('available')"></div>
          <span>Disponible (aucune intervention)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" [style.background-color]="getStatusColor('intervention')"></div>
          <span>Intervention uniquement</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" [style.background-color]="getStatusColor('indispo')"></div>
          <span>Indisponibilité (perte prod/com)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" [style.background-color]="getStatusColor('both')"></div>
          <span>Intervention + Indisponibilité</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Timeline -->
  <div class="timeline-content">
    <div class="timeline-grid">
      <!-- Header Row with Grouping -->
      <div class="timeline-header">
        <div class="equipment-header">
          <div class="equipment-labels">
            <span class="centrale-label">Centrale</span>
            <span class="separator">/</span>
            <span class="equipement-label">Équipement</span>
          </div>
        </div>
        <div class="timeline-header-container">
          @for (group of groupedHeaders; track $index) {
            <div class="header-group">
              @if (group.day) {
                <div class="group-header day-header">{{ group.day }}</div>
              }
              @if (group.month) {
                <div class="group-header month-header">{{ group.month }}</div>
              }
              <div class="slot-headers">
                @for (slot of group.slots; track slot.date.getTime()) {
                  <div class="timeslot-header" 
                       [class.today]="isToday(slot.date)"
                       [style.min-width.px]="displayConfig.cellWidth"
                       [style.width.px]="displayConfig.cellWidth">
                    <div class="header-label">{{ slot.label }}</div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Timeline Rows with Continuous Blocks -->
      @for (row of timelineRows; track row.centrale + row.equipement) {
        <div class="timeline-row">
          <div class="equipment-cell">
            <span class="centrale-name">{{ row.centrale }}</span>
            <span class="separator">/</span>
            <span class="equipement-name">{{ row.equipement }}</span>
          </div>
          <div class="timeline-track-container">
            <div class="timeline-track" [style.width.px]="timelineWidth">
              @for (block of row.blocks; track $index) {
                <div class="intervention-block" 
                     [class.clickable]="block.interventions.length > 0"
                     [style.background-color]="getStatusColor(block.status)"
                     [style.left.px]="block.leftPosition"
                     [style.width.px]="block.width"
                     [matTooltip]="getTooltipText(block)"
                     matTooltipClass="multiline-tooltip"
                     (click)="viewDayDetails(block)">
                </div>
              }
            </div>
          </div>
        </div>
      }

      @if (timelineRows.length === 0) {
        <div class="no-data">
          <mat-icon>info</mat-icon>
          <p>Aucun équipement à afficher</p>
        </div>
      }
    </div>
  </div>
  
  <!-- Filter Sidebar -->
  <app-filter-sidebar #filterSidebar></app-filter-sidebar>
</div>
