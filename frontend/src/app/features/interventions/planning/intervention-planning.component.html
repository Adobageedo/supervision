<div class="planning-container">
  <!-- Toolbar -->
  <mat-toolbar color="primary" class="planning-toolbar">
    <button mat-icon-button (click)="router.navigate(['/interventions'])">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span>Planning des Interventions</span>
    <span class="spacer"></span>
    
    <button mat-icon-button (click)="filterSidebar.open()" aria-label="Filtres">
      <mat-icon>filter_list</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Controls -->
  <div class="controls-bar">
    <div class="view-controls">
      <!-- View Mode Buttons -->
      <mat-button-toggle-group [value]="viewMode" (valueChange)="changeViewMode($event)">
        <mat-button-toggle value="day">
          <mat-icon>today</mat-icon>
          Jour
        </mat-button-toggle>
        <mat-button-toggle value="week">
          <mat-icon>view_week</mat-icon>
          Semaine
        </mat-button-toggle>
        <mat-button-toggle value="month">
          <mat-icon>calendar_month</mat-icon>
          Mois
        </mat-button-toggle>
      </mat-button-toggle-group>

      <!-- Navigation -->
      <div class="navigation-controls">
        <button mat-icon-button (click)="navigatePrevious()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button mat-raised-button (click)="goToToday()">Aujourd'hui</button>
        <button mat-icon-button (click)="navigateNext()">
          <mat-icon>chevron_right</mat-icon>
        </button>
        <span class="date-label">{{ getDateRangeLabel() }}</span>
      </div>

    </div>

    <div class="legend-controls">
      <!-- Color Legend Toggle -->
      <button mat-stroked-button (click)="toggleColorLegend()">
        <mat-icon>palette</mat-icon>
        Couleur par {{ colorLegendMode === 'centrale' ? 'Équipement' : 'Centrale' }}
      </button>
    </div>
  </div>

  <!-- Color Legend -->
  <mat-card class="color-legend">
    <mat-card-content>
      <div class="legend-title">
        <mat-icon>palette</mat-icon>
        <span>Légende - {{ colorLegendMode === 'centrale' ? 'Centrales' : 'Équipements' }}</span>
      </div>
      <div class="legend-items">
        @for (item of getFilteredLegendItems(); track item.key) {
          <div class="legend-item">
            <div class="legend-color" [style.background-color]="item.value"></div>
            <span>{{ item.key }}</span>
          </div>
        }
        @if (getFilteredLegendItems().length === 0) {
          <div class="no-legend">
            <mat-icon>info</mat-icon>
            <span>Aucune donnée à afficher</span>
          </div>
        }
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Calendar View -->
  <div class="calendar-view">
    @if (viewMode === 'day') {
      <!-- Day View -->
      <div class="day-view">
        <div class="day-header">
          <h2>{{ startDate | date:'EEEE d MMMM yyyy':'':'fr' }}</h2>
        </div>
        <div class="events-list">
          @for (event of calendarEvents; track event.intervention.id) {
            <mat-card class="event-card" 
                      [style.border-left-color]="event.color"
                      (click)="viewInterventionDetails(event.intervention)">
              <mat-card-content>
                <div class="event-header">
                  <h3>{{ event.intervention.titre }}</h3>
                  <span class="event-time">
                    {{ event.startDate | date:'HH:mm' }} - 
                    {{ event.endDate | date:'HH:mm' }}
                  </span>
                </div>
                <div class="event-details">
                  <div class="event-detail-item">
                    <strong>Centrale:</strong>
                    <span>{{ event.intervention.centrale }}</span>
                  </div>
                  <div class="event-detail-item">
                    <strong>Équipement:</strong>
                    <span>{{ event.intervention.equipement }}</span>
                  </div>
                  <div class="event-detail-item">
                    <strong>Statut:</strong>
                    <span>{{ getColumnValue(event.intervention, 'statut') }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          }
          @if (calendarEvents.length === 0) {
            <div class="no-events">
              <mat-icon>event_busy</mat-icon>
              <p>Aucune intervention prévue</p>
            </div>
          }
        </div>
      </div>
    }

    @if (viewMode === 'week') {
      <!-- Week View -->
      <div class="week-view">
        <div class="week-grid">
          @for (day of getWeekDays(); track day.getTime()) {
            <div class="day-column" [class.today]="isToday(day)">
              <div class="day-header">
                <div class="day-name">{{ day | date:'EEE':'':'fr' }}</div>
                <div class="day-number">{{ day | date:'d' }}</div>
              </div>
              <div class="day-events">
                @for (event of getEventsForDay(day); track event.intervention.id) {
                  <div class="event-item" 
                       [style.background-color]="event.color"
                       (click)="viewInterventionDetails(event.intervention)"
                       [matTooltip]="event.intervention.titre">
                    <div class="event-title">{{ event.intervention.titre }}</div>
                    <div class="event-time">{{ event.startDate | date:'HH:mm' }}</div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }

    @if (viewMode === 'month') {
      <!-- Month View -->
      <div class="month-view">
        <div class="month-grid">
          <!-- Day headers -->
          <div class="day-header">Lun</div>
          <div class="day-header">Mar</div>
          <div class="day-header">Mer</div>
          <div class="day-header">Jeu</div>
          <div class="day-header">Ven</div>
          <div class="day-header">Sam</div>
          <div class="day-header">Dim</div>

          <!-- Days -->
          @for (day of getMonthDays(); track day.getTime()) {
            <div class="day-cell" 
                 [class.today]="isToday(day)"
                 [class.other-month]="!isCurrentMonth(day)">
              <div class="day-number">{{ day.getDate() }}</div>
              <div class="day-events">
                @for (event of getEventsForDay(day); track event.intervention.id) {
                  <div class="event-dot" 
                       [style.background-color]="event.color"
                       (click)="viewInterventionDetails(event.intervention)"
                       [matTooltip]="event.intervention.titre">
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>
  
  <!-- Filter Sidebar -->
  <app-filter-sidebar #filterSidebar></app-filter-sidebar>
</div>
